<!DOCTYPE html>
<html>
<head>
  <title>Socket.IO Test Client</title>
  <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    pre { background: #f4f4f4; padding: 10px; border-radius: 4px; }
    input { padding: 8px; width: 500px; margin-right: 8px; }
    button { padding: 8px 16px; background: #4CAF50; color: white; border: none; cursor: pointer; }
    .error { color: #f44336; }
    .success { color: #4CAF50; }
    .info { color: #2196F3; }
  </style>
</head>
<body>
  <h1>Socket.IO Test Client</h1>
  
  <div>
    <label for="token">JWT Token:</label><br>
    <input type="text" id="token" placeholder="Paste your JWT token here" /><br><br>
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()" id="disconnectBtn" disabled>Disconnect</button>
  </div>
  
  <div style="margin-top: 20px;">
    <button onclick="loadNotifications()" id="loadBtn" disabled>Load Notifications</button>
    <button onclick="markAllAsRead()" id="markAllBtn" disabled>Mark All as Read</button>
  </div>
  
  <div style="margin-top: 20px;">
    <h2>Connection Log:</h2>
    <pre id="log" style="height: 300px; overflow-y: auto;"></pre>
  </div>

  <script>
    let socket = null;
    
    function log(message, type = 'normal') {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const formattedMessage = `[${timestamp}] ${message}`;
      
      let classType = '';
      if (type === 'error') classType = 'class="error"';
      if (type === 'success') classType = 'class="success"';
      if (type === 'info') classType = 'class="info"';
      
      logElement.innerHTML += `<div ${classType}>${formattedMessage}</div>`;
      logElement.scrollTop = logElement.scrollHeight;
    }

    function connect() {
      const token = document.getElementById('token').value;
      if (!token) {
        log('Error: Please enter a token', 'error');
        return;
      }

      log('Attempting to connect with token...', 'info');
      
      // Close existing connection
      disconnect();
      
      // Create new connection with debugging
      socket = io('http://localhost:8000/notifications', {
        auth: { token },
        transports: ['websocket'],
        reconnection: true,
        reconnectionAttempts: 3,
        timeout: 10000
      });
      
      // Connection events
      socket.on('connect', () => {
        log('Connected successfully!', 'success');
        document.getElementById('disconnectBtn').disabled = false;
        document.getElementById('loadBtn').disabled = false;
        document.getElementById('markAllBtn').disabled = false;
      });
      
      socket.on('error', (error) => {
        log(`Error: ${JSON.stringify(error)}`, 'error');
      });
      
      socket.on('connect_error', (error) => {
        log(`Connect error: ${error.message}`, 'error');
      });
      
      socket.on('disconnect', (reason) => {
        log(`Disconnected: ${reason}`);
        document.getElementById('disconnectBtn').disabled = true;
        document.getElementById('loadBtn').disabled = true;
        document.getElementById('markAllBtn').disabled = true;
      });

      // Notification events
      socket.on('unread_count', (data) => {
        log(`Unread count received: ${data.count}`, 'info');
      });
      
      socket.on('new_notification', (data) => {
        log(`New notification received: ${JSON.stringify(data.notification)}`, 'info');
      });
      
      socket.on('notifications_loaded', (data) => {
        log(`Notifications loaded: ${data.notifications.length} items`, 'info');
        data.notifications.forEach(n => {
          log(`- ${n.title}: ${n.message}`, 'info');
        });
      });

      socket.io.on("reconnect_attempt", (attempt) => {
        log(`Reconnection attempt: ${attempt}`);
      });
      
      socket.io.on("reconnect", (attempt) => {
        log(`Reconnected after ${attempt} attempts`, 'success');
      });
      
      socket.io.on("reconnect_error", (error) => {
        log(`Reconnect error: ${error.message}`, 'error');
      });
    }
    
    function disconnect() {
      if (socket) {
        socket.disconnect();
        socket = null;
        log('Manually disconnected');
        document.getElementById('disconnectBtn').disabled = true;
        document.getElementById('loadBtn').disabled = true;
        document.getElementById('markAllBtn').disabled = true;
      }
    }
    
    function loadNotifications() {
      if (!socket) {
        log('Socket not connected!', 'error');
        return;
      }
      
      log('Requesting notifications...');
      socket.emit('loadNotifications', 1);
    }
    
    function markAllAsRead() {
      if (!socket) {
        log('Socket not connected!', 'error');
        return;
      }
      
      log('Marking all notifications as read...');
      socket.emit('markAllAsRead');
    }
  </script>
</body>
</html>
